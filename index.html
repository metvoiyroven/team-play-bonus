<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Play Casino</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0f0f0f; color: #fff; text-align: center; margin: 0; padding: 20px; }
        .card { background: #1a1a1a; border: 2px solid #333; border-radius: 20px; padding: 20px; box-shadow: 0 0 20px rgba(0,255,0,0.1); }
        .stats { display: flex; justify-content: space-around; margin-bottom: 20px; background: #252525; padding: 10px; border-radius: 10px; }
        .stat-item { font-size: 14px; }
        .stat-value { display: block; font-size: 20px; font-weight: bold; color: #00ff00; }
        
        .case-visual { width: 150px; height: 150px; margin: 20px auto; background: linear-gradient(45deg, #111, #222); border: 3px solid #ffd700; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 50px; cursor: pointer; transition: 0.3s; }
        .case-visual:active { transform: scale(0.9); }
        .case-visual.spinning { animation: shake 0.5s infinite; }

        @keyframes shake {
            0% { transform: rotate(0deg); }
            25% { transform: rotate(5deg); }
            75% { transform: rotate(-5deg); }
            100% { transform: rotate(0deg); }
        }

        button { background: #ffd700; color: #000; border: none; padding: 15px 25px; border-radius: 12px; font-weight: bold; font-size: 18px; width: 100%; cursor: pointer; }
        button:disabled { background: #555; cursor: not-allowed; }
        
        .win-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .win-overlay h2 { color: #ffd700; }
    </style>
</head>
<body>

<div class="card">
    <div class="stats">
        <div class="stat-item">–ó–≤–µ–∑–¥—ã: <span id="stars" class="stat-value">0</span></div>
        <div class="stat-item">–ë–æ–Ω—É—Å—ã: <span id="balance" class="stat-value">0</span></div>
    </div>
    
    <div id="case" class="case-visual">üéÅ</div>
    <p>–¶–µ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è: <b>100 BP</b></p>
    <button id="open-btn">–û–¢–ö–†–´–¢–¨ –ö–ï–ô–°</button>
</div>

<div id="win-screen" class="win-overlay">
    <h2>–ü–û–ó–î–†–ê–í–õ–Ø–ï–ú!</h2>
    <div id="win-text" style="font-size: 24px; margin: 20px;">–ü–†–ò–ó</div>
    <button onclick="closeWin()">–ó–ê–ë–†–ê–¢–¨</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, increment, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // –í–°–¢–ê–í–¨ –°–í–û–ô –ö–û–ù–§–ò–ì –ò–ó –°–¢–ê–†–û–ì–û –§–ê–ô–õ–ê
    const firebaseConfig = {
        apiKey: "–¢–í–û–ô_API_KEY",
        authDomain: "teamplaybonus.firebaseapp.com",
        projectId: "teamplaybonus",
        storageBucket: "teamplaybonus.appspot.com",
        messagingSenderId: "...",
        appId: "..."
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const tg = window.Telegram.WebApp;
    tg.expand();

    const user = tg.initDataUnsafe?.user;
    const userRef = user ? doc(db, "players", user.id.toString()) : null;

    const prizes = [
        { name: "500 –ó–≤–µ–∑–¥", chance: 1, type: "stars", val: 500 },
        { name: "450 –ó–≤–µ–∑–¥", chance: 1, type: "stars", val: 450 },
        { name: "400 –ó–≤–µ–∑–¥", chance: 1, type: "stars", val: 400 },
        { name: "6—á VIP", chance: 1, type: "item" },
        { name: "6—á STANDART", chance: 1, type: "item" },
        { name: "3—á VIP", chance: 3, type: "item" },
        { name: "350 –ó–≤–µ–∑–¥", chance: 4, type: "stars", val: 350 },
        { name: "3—á STANDART", chance: 4, type: "item" },
        { name: "300 –ó–≤–µ–∑–¥", chance: 5, type: "stars", val: 300 },
        { name: "1—á VIP", chance: 6, type: "item" },
        { name: "1—á STANDART", chance: 10, type: "item" },
        { name: "–ü–° 5 - 1—á", chance: 10, type: "item" },
        { name: "250 –ó–≤–µ–∑–¥", chance: 10, type: "stars", val: 250 },
        { name: "200 –ó–≤–µ–∑–¥", chance: 20, type: "stars", val: 200 },
        { name: "–ü–° 4 - 1—á", chance: 20, type: "item" },
        { name: "150 –ó–≤–µ–∑–¥", chance: 50, type: "stars", val: 150 },
        { name: "100 –ó–≤–µ–∑–¥", chance: 70, type: "stars", val: 100 },
        { name: "50 –ó–≤–µ–∑–¥", chance: 80, type: "stars", val: 50 }
    ];

    async function loadStats() {
        if (!userRef) return;
        const snap = await getDoc(userRef);
        if (snap.exists()) {
            const data = snap.data();
            document.getElementById('balance').innerText = data.points || 0;
            document.getElementById('stars').innerText = data.stars || 0;
        }
    }

    window.closeWin = () => {
        document.getElementById('win-screen').style.display = 'none';
        loadStats();
    };

    document.getElementById('open-btn').onclick = async () => {
        const snap = await getDoc(userRef);
        if (snap.data().points < 100) {
            alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –±–æ–Ω—É—Å–æ–≤ (–Ω—É–∂–Ω–æ 100 BP)");
            return;
        }

        // –ê–Ω–∏–º–∞—Ü–∏—è
        const caseEl = document.getElementById('case');
        caseEl.classList.add('spinning');
        document.getElementById('open-btn').disabled = true;

        setTimeout(async () => {
            const rand = Math.random() * 100;
            let win = prizes[prizes.length - 1]; // –î–µ—Ñ–æ–ª—Ç–Ω—ã–π –ø—Ä–∏–∑

            for (let p of prizes) {
                if (rand <= p.chance) {
                    win = p;
                    break;
                }
            }

            // –ó–∞–ø–∏—Å—å –≤ –±–∞–∑—É
            const updateData = { points: increment(-100) };
            if (win.type === "stars") updateData.stars = increment(win.val);
            if (win.type === "item") updateData.inventory = arrayUnion(win.name);

            await setDoc(userRef, updateData, { merge: true });

            caseEl.classList.remove('spinning');
            document.getElementById('win-text').innerText = win.name;
            document.getElementById('win-screen').style.display = 'flex';
            document.getElementById('open-btn').disabled = false;
            tg.HapticFeedback.notificationOccurred('success');
        }, 1500);
    };

    loadStats();
</script>

</body>
</html>
