<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Team Play Premium</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { 
            --gold: #ffd700; --bg: #0a0a0a; --card: #161616; --text: #ffffff; --sub: #888888;
            --accent: linear-gradient(45deg, #ffd700, #ffae00);
        }
        body.light-theme {
            --bg: #f5f5f5; --card: #ffffff; --text: #1a1a1a; --sub: #666666;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; transition: 0.3s; }
        
        /* Navigation */
        .nav { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid rgba(255,255,255,0.05); z-index: 1000; }
        .nav-item { color: var(--sub); font-size: 10px; display: flex; flex-direction: column; align-items: center; border: none; background: none; flex: 1; transition: 0.2s; }
        .nav-item.active { color: var(--gold); transform: translateY(-3px); }
        .nav-icon { font-size: 22px; margin-bottom: 4px; }

        .page { display: none; padding: 20px; animation: slideUp 0.4s ease-out; padding-bottom: 100px; }
        .page.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .header-stars { text-align: center; padding: 20px; font-size: 28px; font-weight: 900; color: var(--gold); }

        /* Case Box */
        .glass { background: var(--card); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; padding: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
        .box-visual { width: 160px; height: 160px; margin: 0 auto; display: flex; align-items: center; justify-content: center; font-size: 70px; cursor: pointer; transition: 0.3s; }
        .box-visual.opening { animation: shake 0.5s infinite; }
        @keyframes shake { 0% { transform: rotate(0); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0); } }

        /* Items */
        .item-card { background: var(--card); padding: 15px; border-radius: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255,255,255,0.05); }
        .btn-main { background: var(--accent); color: #000; border: none; padding: 15px; border-radius: 12px; font-weight: 800; width: 100%; margin-top: 10px; cursor: pointer; }
        .btn-use { background: #333; color: var(--gold); border: 1px solid var(--gold); padding: 8px 12px; border-radius: 8px; font-size: 12px; font-weight: bold; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .input-group { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; margin: 10px 0; display: flex; }
        input { background: none; border: none; color: var(--text); padding: 5px; flex: 1; outline: none; font-size: 16px; }
    </style>
</head>
<body>

    <div class="header-stars" id="top-stars">0 ‚≠ê</div>

    <div id="p-home" class="page active">
        <h2 style="margin-top:0">–ù–æ–≤–æ—Å—Ç–∏</h2>
        <div class="glass" style="text-align: center; padding: 50px 20px;">
            <span style="font-size: 50px;">üì°</span>
            <h3 style="color: var(--gold); margin-bottom: 10px;">–°–ö–û–†–û –ü–û–Ø–í–ò–¢–°–Ø</h3>
            <p style="color: var(--sub)">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ. –ó–¥–µ—Å—å –±—É–¥—É—Ç –∞–∫—Ü–∏–∏ –∫–ª—É–±–∞!</p>
        </div>
    </div>

    <div id="p-games" class="page">
        <h2>–ò–≥—Ä—ã</h2>
        <div class="glass" style="text-align: center;">
            <div id="main-box" class="box-visual" onclick="showChances()">üéÅ</div>
            <p style="margin: 5px 0;">–ù–∞–∂–º–∏ –Ω–∞ –∫–µ–π—Å, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø—Ä–∏–∑—ã</p>
            <h3 style="color: var(--gold); margin: 15px 0;">–¶–µ–Ω–∞: 100 ‚≠ê</h3>
            <button class="btn-main" onclick="openCase()">–û–¢–ö–†–´–¢–¨ –ö–ï–ô–°</button>
        </div>
    </div>

    <div id="p-top" class="page">
        <h2>–†–µ–π—Ç–∏–Ω–≥ –∫–ª—É–±–∞</h2>
        <div id="leaderboard-list"></div>
    </div>

    <div id="p-bonuses" class="page">
        <h2>–ë–æ–Ω—É—Å—ã</h2>
        <div class="glass" style="text-align: center;">
            <p>–•–æ—á–µ—à—å –Ω–∞–∫–æ–ø–∏—Ç—å –Ω–∞ –∫–µ–π—Å?</p>
            <button class="btn-main" onclick="claimFree()">–ü–û–õ–£–ß–ò–¢–¨ +10 ‚≠ê</button>
        </div>
    </div>

    <div id="p-profile" class="page">
        <h2>–ü—Ä–æ—Ñ–∏–ª—å</h2>
        <div class="glass" style="margin-bottom: 20px;">
            <label style="font-size: 12px; color: var(--sub)">–¢–≤–æ–π –Ω–∏–∫–Ω–µ–π–º</label>
            <div class="input-group">
                <input type="text" id="username-input" placeholder="–ù–∏–∫...">
                <button onclick="saveNick()" style="background:none; border:none; color:var(--gold); font-weight:bold;">–û–ö</button>
            </div>
            
            <label style="font-size: 12px; color: var(--sub)">–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞</label>
            <div class="input-group">
                <input type="text" id="promo-input" placeholder="–ö–æ–¥...">
                <button onclick="applyPromo()" style="background:none; border:none; color:var(--gold); font-weight:bold;">–í–í–ï–°–¢–ò</button>
            </div>

            <button class="btn-main" style="background:#222; color:#fff; border: 1px solid #444;" onclick="toggleTheme()">–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É üåó</button>
        </div>

        <h3>–¢–≤–æ–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å</h3>
        <div id="inventory-list"></div>
    </div>

    <nav class="nav">
        <button class="nav-item active" onclick="tab('home', this)"><span class="nav-icon">üè†</span>–ì–ª–∞–≤–Ω–∞—è</button>
        <button class="nav-item" onclick="tab('games', this)"><span class="nav-icon">üé≤</span>–ò–≥—Ä—ã</button>
        <button class="nav-item" onclick="tab('top', this)"><span class="nav-icon">üèÜ</span>–¢–æ–ø</button>
        <button class="nav-item" onclick="tab('bonuses', this)"><span class="nav-icon">üíé</span>–ë–æ–Ω—É—Å—ã</button>
        <button class="nav-item" onclick="tab('profile', this)"><span class="nav-icon">üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</button>
    </nav>

    <div id="modal-chances" class="modal">
        <h2 style="color:var(--gold)">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–µ–π—Å–∞:</h2>
        <div id="chances-list" style="text-align:left; font-size:14px; line-height:1.8;"></div>
        <button class="btn-main" onclick="document.getElementById('modal-chances').style.display='none'">–ó–ê–ö–†–´–¢–¨</button>
    </div>

    <div id="win-screen" class="modal" style="display:none; justify-content:center; align-items:center; flex-direction:column; text-align:center;">
        <h1 style="color:var(--gold); font-size:40px; margin:0;">–í–´–ò–ì–†–´–®!</h1>
        <div id="win-item-name" style="font-size: 28px; margin: 30px; font-weight:bold;">–ü—Ä–∏–∑</div>
        <button class="btn-main" style="width:200px" onclick="location.reload()">–ó–ê–ë–†–ê–¢–¨</button>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, increment, arrayUnion, collection, query, orderBy, limit, getDocs, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBk4HzLYN19C4V7SyGMU1d1z33I98X5TDI",
        authDomain: "teamplaybonus.firebaseapp.com",
        projectId: "teamplaybonus",
        storageBucket: "teamplaybonus.firebasestorage.app",
        messagingSenderId: "968832825102",
        appId: "1:968832825102:web:675d627c0e0733dc995c3f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const tg = window.Telegram.WebApp;
    tg.expand();

    const uid = tg.initDataUnsafe?.user?.id.toString() || "test_id";
    const userRef = doc(db, "players", uid);

    // –ü–û–õ–ù–´–ô –°–ü–ò–°–û–ö –ü–†–ò–ó–û–í –ò–ó –¢–í–û–ï–ì–û –ó–ê–ü–†–û–°–ê
    const prizes = [
        { name: "6—á VIP", chance: 1 },
        { name: "6—á STANDART", chance: 1 },
        { name: "500 –ó–≤–µ–∑–¥", chance: 1 },
        { name: "450 –ó–≤–µ–∑–¥", chance: 1 },
        { name: "400 –ó–≤–µ–∑–¥", chance: 1 },
        { name: "3—á VIP", chance: 3 },
        { name: "3—á STANDART", chance: 4 },
        { name: "350 –ó–≤–µ–∑–¥", chance: 4 },
        { name: "300 –ó–≤–µ–∑–¥", chance: 5 },
        { name: "1—á VIP", chance: 6 },
        { name: "1—á STANDART", chance: 10 },
        { name: "–ü–° 5 - 1—á", chance: 10 },
        { name: "250 –ó–≤–µ–∑–¥", chance: 10 },
        { name: "–ü–° 4 - 1—á", chance: 20 },
        { name: "200 –ó–≤–µ–∑–¥", chance: 20 },
        { name: "150 –ó–≤–µ–∑–¥", chance: 50 },
        { name: "100 –ó–≤–µ–∑–¥", chance: 70 },
        { name: "50 –ó–≤–µ–∑–¥", chance: 80 }
    ];

    window.tab = (name, el) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('p-'+name).classList.add('active');
        el.classList.add('active');
        if(name === 'top') loadTop();
        if(name === 'profile') loadInventory();
    };

    async function sync() {
        const snap = await getDoc(userRef);
        if (snap.exists()) {
            const d = snap.data();
            document.getElementById('top-stars').innerText = (d.stars || 0) + ' ‚≠ê';
            if(!document.getElementById('username-input').value) document.getElementById('username-input').value = d.name || "";
        } else {
            await setDoc(userRef, { name: tg.initDataUnsafe?.user?.first_name || "–ò–≥—Ä–æ–∫", stars: 100, inventory: [], openCount: 0 });
        }
    }

    window.showChances = () => {
        const list = document.getElementById('chances-list');
        list.innerHTML = prizes.map(p => `<div>‚Ä¢ ${p.name} <span style="color:gray;float:right;">${p.chance}%</span></div>`).join('');
        document.getElementById('modal-chances').style.display = 'block';
    };

    window.openCase = async () => {
        const snap = await getDoc(userRef);
        if((snap.data().stars || 0) < 100) { tg.showAlert("–ú–∞–ª–æ –∑–≤–µ–∑–¥! –ù—É–∂–Ω–æ 100 ‚≠ê"); return; }

        const box = document.getElementById('main-box');
        box.classList.add('opening');

        setTimeout(async () => {
            const rand = Math.random() * 100;
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Ç —Å–∞–º–æ–≥–æ —Ä–µ–¥–∫–æ–≥–æ –∫ —á–∞—Å—Ç–æ–º—É –¥–ª—è –ª–æ–≥–∏–∫–∏ –≤—ã–ø–∞–¥–µ–Ω–∏—è
            const sortedPrizes = [...prizes].sort((a,b) => a.chance - b.chance);
            let win = sortedPrizes.find(p => rand <= p.chance) || sortedPrizes[sortedPrizes.length-1];

            const item = { id: Date.now(), name: win.name, date: new Date().toLocaleDateString(), used: false };
            
            // –ï—Å–ª–∏ –≤—ã–∏–≥—Ä–∞–ª–∏ –∑–≤–µ–∑–¥—ã –Ω–∞–ø—Ä—è–º—É—é
            let starBonus = 0;
            if(win.name.includes("–ó–≤–µ–∑–¥")) starBonus = parseInt(win.name);

            await updateDoc(userRef, {
                stars: increment(-100 + starBonus),
                openCount: increment(1),
                inventory: arrayUnion(item)
            });

            box.classList.remove('opening');
            document.getElementById('win-item-name').innerText = win.name;
            document.getElementById('win-screen').style.display = 'flex';
            tg.HapticFeedback.notificationOccurred('success');
        }, 2000);
    };

    window.loadInventory = async () => {
        const snap = await getDoc(userRef);
        const list = document.getElementById('inventory-list');
        list.innerHTML = "";
        const inv = snap.data().inventory || [];
        inv.reverse().forEach(item => {
            list.innerHTML += `<div class="item-card">
                <div><b>${item.name}</b><br><small style="color:var(--sub)">${item.date}</small></div>
                ${item.used ? '<span style="color:var(--sub)">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ</span>' : `<button class="btn-use" onclick="useItem(${item.id})">–ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨</button>`}
            </div>`;
        });
    };

    window.useItem = async (id) => {
        tg.showConfirm("–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∫–ª—É–±–∞ –¥–æ–ª–∂–µ–Ω –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–∑–∞. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?", async (ok) => {
            if(ok) {
                const snap = await getDoc(userRef);
                const newInv = snap.data().inventory.map(i => i.id === id ? {...i, used: true} : i);
                await updateDoc(userRef, { inventory: newInv });
                loadInventory();
            }
        });
    };

    window.loadTop = async () => {
        const q = query(collection(db, "players"), orderBy("stars", "desc"), limit(10));
        const snap = await getDocs(q);
        const list = document.getElementById('leaderboard-list');
        list.innerHTML = "";
        let i = 1;
        snap.forEach(d => {
            const data = d.data();
            list.innerHTML += `<div class="item-card">
                <div><b>#${i}</b> ${data.name || "–ò–≥—Ä–æ–∫"}</div>
                <div style="text-align:right"><b>${data.stars || 0} ‚≠ê</b><br><small style="font-size:10px">–ö–µ–π—Å–æ–≤: ${data.openCount || 0}</small></div>
            </div>`;
            i++;
        });
    };

    window.claimFree = async () => {
        await updateDoc(userRef, { stars: increment(10) });
        tg.showAlert("–í—ã –ø–æ–ª—É—á–∏–ª–∏ 10 ‚≠ê!");
        sync();
    };

    window.saveNick = async () => {
        const nick = document.getElementById('username-input').value;
        if(nick) {
            await updateDoc(userRef, { name: nick });
            tg.showAlert("–ù–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!");
        }
    };

    window.applyPromo = async () => {
        const code = document.getElementById('promo-input').value.toUpperCase();
        if(code === 'START') {
            await updateDoc(userRef, { stars: increment(1000) });
            tg.showAlert("–ü—Ä–æ–º–æ–∫–æ–¥ START: +1000 ‚≠ê!");
            document.getElementById('promo-input').value = "";
            sync();
        } else { tg.showAlert("–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥"); }
    };

    window.toggleTheme = () => { document.body.classList.toggle('light-theme'); };

    sync();
</script>
</body>
</html>
