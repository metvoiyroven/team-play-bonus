<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Team Play Club</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --main: #ffd700; --bg: #0f0f0f; --card: #1a1a1a; --text: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 70px; }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav { position: fixed; bottom: 0; width: 100%; background: #111; display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid #333; z-index: 1000; }
        .nav-btn { color: #888; font-size: 12px; display: flex; flex-direction: column; align-items: center; cursor: pointer; border: none; background: none; }
        .nav-btn.active { color: var(--main); }

        /* –†–∞–∑–¥–µ–ª—ã */
        .page { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .stat-card { background: var(--card); padding: 15px; border-radius: 15px; text-align: center; margin-bottom: 15px; border: 1px solid #333; }
        .val { font-size: 24px; font-weight: bold; color: var(--main); display: block; }

        /* –ö–µ–π—Å—ã */
        .case-visual { width: 180px; height: 180px; background: linear-gradient(45deg, #1a1a1a, #222); border: 2px dashed var(--main); border-radius: 20px; margin: 20px auto; display: flex; align-items: center; justify-content: center; font-size: 60px; transition: 0.3s; }
        .spinning { animation: shake 0.5s infinite; }
        @keyframes shake { 0%, 100% { transform: rotate(0); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }

        /* –°–ø–∏—Å–∫–∏ */
        .item { background: var(--card); margin: 10px 0; padding: 12px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; }
        button { background: var(--main); color: #000; border: none; padding: 15px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; }
        button:disabled { background: #555; }

        .win-popup { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    </style>
</head>
<body>

<div id="page-main" class="page active">
    <h2>–¢–≤–æ–π –ü—Ä–æ—Ñ–∏–ª—å</h2>
    <div class="stat-card">–¢–≤–æ–π –±–∞–ª–∞–Ω—Å <span id="balance" class="val">0 BP</span></div>
    <div class="stat-card">–¢–≤–æ–∏ –ó–≤–µ–∑–¥—ã <span id="stars" class="val">0 ‚≠ê</span></div>
    <button id="claim-btn">–ü–û–õ–£–ß–ò–¢–¨ +10 BP</button>
</div>

<div id="page-cases" class="page">
    <h2>–ö–µ–π—Å –ö–ª—É–±–∞</h2>
    <div id="box" class="case-visual">üéÅ</div>
    <p style="text-align:center">–°—Ç–æ–∏–º–æ—Å—Ç—å –æ—Ç–∫—Ä—ã—Ç–∏—è: <b>100 BP</b></p>
    <button id="open-btn">–û–¢–ö–†–´–¢–¨ –ö–ï–ô–°</button>
</div>

<div id="page-inv" class="page">
    <h2>–ú–æ–π –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
    <div id="inv-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div id="page-top" class="page">
    <h2>–¢–æ–ø –ò–≥—Ä–æ–∫–æ–≤</h2>
    <div id="top-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
</div>

<div class="nav">
    <button class="nav-btn active" onclick="tab('main')"><span>üë§</span>–ü—Ä–æ—Ñ–∏–ª—å</button>
    <button class="nav-btn" onclick="tab('cases')"><span>üé∞</span>–ö–µ–π—Å—ã</button>
    <button class="nav-btn" onclick="tab('inv')"><span>üéí</span>–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
    <button class="nav-btn" onclick="tab('top')"><span>üèÜ</span>–¢–æ–ø</button>
</div>

<div id="win-screen" class="win-popup">
    <h1 style="color:var(--main)">–í–´–ò–ì–†–´–®!</h1>
    <div id="win-name" style="font-size: 30px; margin: 20px;">–ü–†–ò–ó</div>
    <button style="width:200px" onclick="location.reload()">–ó–ê–ë–†–ê–¢–¨</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, increment, arrayUnion, collection, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBk4HzLYN19C4V7SyGMU1d1z33I98X5TDI",
        authDomain: "teamplaybonus.firebaseapp.com",
        projectId: "teamplaybonus",
        storageBucket: "teamplaybonus.firebasestorage.app",
        messagingSenderId: "968832825102",
        appId: "1:968832825102:web:675d627c0e0733dc995c3f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const tg = window.Telegram.WebApp;
    tg.expand();

    const user = tg.initDataUnsafe?.user;
    const userRef = user ? doc(db, "players", user.id.toString()) : null;

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
    window.tab = (name) => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('page-'+name).classList.add('active');
        event.currentTarget.classList.add('active');
        if(name === 'inv') loadInventory();
        if(name === 'top') loadTop();
    };

    async function updateUI() {
        if (!userRef) return;
        const snap = await getDoc(userRef);
        if (snap.exists()) {
            document.getElementById('balance').innerText = (snap.data().points || 0) + ' BP';
            document.getElementById('stars').innerText = (snap.data().stars || 0) + ' ‚≠ê';
        }
    }

    document.getElementById('claim-btn').onclick = async () => {
        await setDoc(userRef, { name: user.username || user.first_name, points: increment(10) }, { merge: true });
        tg.HapticFeedback.impactOccurred('light');
        updateUI();
    };

    // –ü–†–ò–ó–´ –ò –®–ê–ù–°–´ (–õ–æ–≥–∏–∫–∞: –æ—Ç —Ä–µ–¥–∫–æ–≥–æ –∫ —á–∞—Å—Ç–æ–º—É)
    const prizes = [
        { name: "500 –ó–≤–µ–∑–¥", chance: 1, type: "stars", val: 500 },
        { name: "450 –ó–≤–µ–∑–¥", chance: 1, type: "stars", val: 450 },
        { name: "6—á VIP", chance: 1, type: "item" },
        { name: "6—á STANDART", chance: 1, type: "item" },
        { name: "3—á VIP", chance: 3, type: "item" },
        { name: "3—á STANDART", chance: 4, type: "item" },
        { name: "1—á VIP", chance: 6, type: "item" },
        { name: "1—á STANDART", chance: 10, type: "item" },
        { name: "–ü–° 5 - 1—á", chance: 10, type: "item" },
        { name: "–ü–° 4 - 1—á", chance: 20, type: "item" },
        { name: "100 –ó–≤–µ–∑–¥", chance: 70, type: "stars", val: 100 },
        { name: "50 –ó–≤–µ–∑–¥", chance: 100, type: "stars", val: 50 }
    ];

    document.getElementById('open-btn').onclick = async () => {
        const snap = await getDoc(userRef);
        if ((snap.data().points || 0) < 100) { tg.showAlert("–ù—É–∂–Ω–æ 100 BP!"); return; }

        document.getElementById('box').classList.add('spinning');
        
        setTimeout(async () => {
            const rand = Math.random() * 100;
            let win = prizes.find(p => rand <= p.chance) || prizes[prizes.length-1];

            const upd = { points: increment(-100) };
            if (win.type === "stars") upd.stars = increment(win.val);
            if (win.type === "item") upd.inventory = arrayUnion({ name: win.name, date: new Date().toLocaleDateString() });

            await setDoc(userRef, upd, { merge: true });
            
            document.getElementById('box').classList.remove('spinning');
            document.getElementById('win-name').innerText = win.name;
            document.getElementById('win-screen').style.display = 'flex';
            tg.HapticFeedback.notificationOccurred('success');
        }, 1500);
    };

    async function loadInventory() {
        const snap = await getDoc(userRef);
        const list = document.getElementById('inv-list');
        list.innerHTML = '';
        if (snap.exists() && snap.data().inventory) {
            snap.data().inventory.forEach(i => {
                list.innerHTML += `<div class="item"><span>${i.name}</span><small>${i.date}</small></div>`;
            });
        } else { list.innerHTML = '–ü—É—Å—Ç–æ... –û—Ç–∫—Ä–æ–π —Å–≤–æ–π –ø–µ—Ä–≤—ã–π –∫–µ–π—Å!'; }
    }

    async function loadTop() {
        const q = query(collection(db, "players"), orderBy("stars", "desc"), limit(10));
        const snap = await getDocs(q);
        const list = document.getElementById('top-list');
        list.innerHTML = '';
        snap.forEach((doc, i) => {
            list.innerHTML += `<div class="item"><span>#${i+1} ${doc.data().name}</span><b>${doc.data().stars || 0} ‚≠ê</b></div>`;
        });
    }

    updateUI();
</script>
</body>
</html>
